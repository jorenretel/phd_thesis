
(Semi-) Automatic Assignment of Solid-State NMR spectra
=======================================================

Over the years a lot of different sequential assignment algorithms have been written. This is completely understandable since this is a completely deterministic problem, the kind computers are actually very good at solving. However, a lot of these scripts suffer from limitations that made them unsuitable to use in my project. None of the methods was able to correctly deal with 2- and 1,3-glycerol labeled samples, for instance. A more general problem is that most algorithms are implemented as stand-alone applications. This often invokes a complicated work-flow in which one has to export several peak and resonance lists from the program that is used to do the analysis of the NMR spectra and convert them to the format expected by the routine. Afterwards the results should be imported back into the analysis program so the result can be analyzed. This is not necessarily bad if it has to be done only be done once. However, for complex assignment projects, with a work-flow in which new data and assignments are added incrementally, this becomes cumbersome. Ironically, often these programs do not get used either for the less complicated assignment tasks since the expected payoff is lower for the user when the assignment can also be done by hand in a reasonable amount of time. Installing the program, converting a hand full of text files and having to check the results afterwards in a not so straight-forward way might be enough to scare off users that would potentially have gotten perfect results using an automatic assignment algorithm.

Also the type of data these stand-alone applications output is somewhat problematic. Often this is one possible sequential assignment that is the true one according to the program. In other words, there is little space for human interference. It would be great however to be able to compare the alternative assignments that the algorithm had to consider and cherry-pick the results for those assignments you actually believe are correct. Many of these problems can be easily overcome when the (semi-) automatic assignment algorithm is integrated within the analysis program. CCPN Analysis databases a lot of information that is relevant to an automatic assignment routine, that would often be lost in a export-import routine. The program has a great Application Programming Interface (API) that gives access to all information stored in the project by the user.

It was not the initial goal to write an assignment algorithm, but to create a tool that would help compare alternative assignment possibilities in a fast way. Because of the extensive use of different labeling schemes used in the assignment of OmpG the peaks that sequentially connect spin systems are often spread over a large amount of spectra. Therefor I needed a tool that would show me which peaks are expected in all differently labeled experiments for two sequential residues A and B. Furthermore the tool should then use the resonance information from all combinations of spin systems A' and B' with a residue type assignment that matches the types of residues A and B to cross check whether there are indeed peaks in the peak lists at the expected positions. The general idea is that the more sequential peaks present and the better these peaks fit the expected positions, the higher the likelihood that these two spin systems are indeed sequentially connected. The only method I could use before, was to plot rulers on the spectra at the resonance frequencies of the nuclei within a pair of spin systems A' and B'. Then the intersections of those rulers could be used to check whether there were the expected crosspeaks in different spectra. Of course this was too slow to systematically try out all combinations of spin systems over the whole sequence. Also, when this does not immediately result in a sequential assignment it is hard to remember or write down which combinations of spin systems fit together sequentially and to which extend. Therefor information can easily be lost and work has to be redone.

Of course, an application that compares different assignment possibilities for two sequential residues can easily be abstracted to the whole sequence. And this is what was done. A optimization procedure can be used to find out the optimal mapping between spin systems and residues. In figure {@fig:malandro_flow_diagram} an overview is given of the different steps in the algorithm, which are discussed in more detail in the following paragraphs.



#### 1. Input of data

 In the first step the input to the algorithm is gathered. In principle most information can be automatically loaded from the CCPN project:

* molecular topology
* labeling schemes
* experiment types describing the magnetization transfer pathway
* picked peaks
* spin systems
* shift lists
* assignment tolerances
* previously made sequential, tentative, and non-sequential amino acid type assignments

Not all information that is databased in the project has to be used necessarily. The user can choose which information is used and which is not. Excluding certain information can be practical when one wants to check a ready made assignment for instance. Spin systems in CCPN Analysis can basically have one of to following five levels of assignment: 1) The most definite form of assignment is of course when a spin system is sequentially assigned to a specific residue in the sequence. 2) One level of assignment lower, a spin system can be assigned 'tentatively' to multiple residues but it is not known which of those residues is the correct one. 3) Then there are spin systems that are residue typed, but no information about sequential assignment is present. 4) Also multiple residue types can be set for a residue. This option is not standardly accessible in the GUI of CCPN Analysis, but is present in the API and called ResidueTypeProbs. This is handy because often a residue type can be narrowed down to two very closely related residue types like asparagine and aspartic acid. 5) The spin systems with the lowest level of assignment are those that for which not any form of sequential assignment nor residue type information is available.

In the part of the GUI shown in figure {@fig:malandro_gui}B it can be configured which of these different levels of assignment are used. If residue type information is not available or  not used, the residue typing algorithm already included in CCPN will be used to classify the spin systems to residue types. Because in most cases the classification is not definite, the user can set a threshold score above which residue types will considered a possibility.

There is one more type of assignments that can either be used or not by the algorithm, namely the assignment of peak dimensions to specific nuclei (resonances in CCPN). If this information is used, the only possible assignment of a peak dimension that is considered is the present assignment.

Furthermore the molecular chain to be used (the molecule) has to be selected. Optionally, parts of the chain that should not be considered for assignment can be entered. This last option can be used if it is clear that parts of the molecule can not be seen because of dynamics or for instance incomplete back-exchange of protons.

#### 2 Evaluate possible mapping between spin systems and residues

On the basis of the different levels of assignment describe above and which of that information should be used, for each spin system a set of possible residue assignments is created. Based on these sets, it can already be determined for each spin system with which other spin systems it could ever exchange sequential assignments in the Monte Carlo procedure later on. This information is used during the Monte Carlo procedure to pick which two spin systems to exchange. Also, at this stage 'joker' spin systems are introduced to make sure that always a spin system can be assigned to every residue. This is important since the Monte Carlo procedure was designed to select two spin systems and exchanging their residue assignments rather than the other way around. For this reason all residues should always have a spin system assigned to them, because once that would not be case no spin system will ever be assigned to it.

#### 3 Predict peak pattern

The intra-residual and sequential peak patterns are predicted based on the molecular topology, the experiment graph and the isotope labeling scheme. Each spectrum in a CCPN project is connected to an experiment type. Normally, the user is prompted to set the experiment type for each new spectrum that is loaded into the CCPN project. When this was not done, it can be set afterwards and is essential for this algorithm to work. In the CCPN data model each experiment type is connected to an experiment graph. This graph describes which magnetization transfers happen during the experiment and how parts of the experiment map to dimensions in the spectrum. For each magnetization transfer information is present about which types of nuclei take part, whether the transfer is through-space or through-bond and whether a transfer from a nucleus to itself can happen. The specified atom types are not restricted to just isotopes but can be more specific, only aromatic carbons for instance. Together with the molecular topology, the graph can be walked recursively to generate a list of expected peaks for virtually any correlation experiment. This list is then filtered by the labeling scheme. For each peak the colabeling fraction over all nuclei on the magnetization transfer pathway is calculated. Only if the colabeling fraction exceeds a user defined variable the peak is retained. By default this minimal colabeling fraction is 0.1.


#### 4 Match predicted and real peaks

Now that a peak pattern is predicted for each spectrum, this can be matched with the peaks in the peak lists corrsponding to those spectra. The positions of the expected peaks can be determined using the chemical shifts assigned to resonances in the spin systems. Of course we don't know yet at this moment which spin systems is in which position on the sequence as that is the purpose of this algorithm. Therefor the possible mapping between residues and spin systems determined in step 2 is used. For every two sequentially neighboring residues A and B, all combinations of spin systems A' and B' are used to search the peak lists, see figure {@fig:malandro_peak_matching} A. The position of the expected sequential peaks will be different for each combination of A' and B'. To find out which peaks in the peaklists match to the expected pattern a chemical shift tolerance is used in each dimension of the spectrum. For each dimension of each spectrum a assignment tolerance can be set in CCPN Analysis, and those olerances are used here aswell.

The more of the expected sequential cross peaks are present in the peak lists, the likelier it is that a specific combination A'-B' is indeed a sequential pair. It is also important how well the actual peak positions fit the expected positions. To do this, for each matched peak a simple function is used that assigns an energy between 0 and -1 depending on the difference between cross-peak and expected peak position. That value is then multiplied with the square of the number of resonances involved with the expected peak to acknowledge that peaks in higher dimensional spectra carry more weight. This number is mostly equal to the number of dimensions, except for partially diagonal peaks. For instance the N~resonances~ for a diagonal peak in a NCOCX spectrum would be 2 instead of 3, which it should be since it contributes less prove for a sequential connection between two spin systems than an off-diagonal peak. Furthermore the energy is normalized by the symmetry of the spectrum the peak is in. A 2D ^13^C-^13^C correlation for instance has two sets of crosspeaks on each side of the diagonal, making the symmetry 2. All together the energy contribution of one peak can then be expressed as:

$$ E_{peak} = max(-1, \sum_{n=1}^{N_{d}} (\frac{\Delta\delta _{n}}{t_{n}}^2 - 1) \frac{1}{N_{d}(1-k^2)}) \frac{N_{resonances} ^2}{symmetry} $$

Where N~d~ is the number of dimensions, ∆δ~n~ is the difference between the shift of the peak and the shift from the shiftlist in the n-th dimension, t~n~ is the tolerance in the n-th dimension and k is the fraction of the tolerance window that has a flat bottom. This last value is set by default on 0.4.
The flat bottom was introduced to prevent over-interpreting small differences between the peak and the expected position. The energy then goes up gradually and becomes 0 for peaks that are all the way in the corner of the tolerance window, see figure {@fig:malandro_peak_matching} B.

As discussed before chemical shifts can differ between spectra depending on the sample and experimental conditions such as temperature and isotope shifts. If these kind of differences are present it is important that spectra are connected to different shift lists. The correct shift list is then used by this algorithm to perform this matching step.

Besides from sequential cross-peaks, also intra-residual cross-peaks are matched. They do not play a role during the optimization of the sequential assignment as they carry no sequential information. However, it is useful to collect these peaks as well, since they can be used for a quick assignment of peaks in new spectra to already known spin systems.


![The expected peaks can be matched to picked peaks in the spectra. Therefor the chemical shifts of all combinations of spin systems A', B' that can be assigned to sequential residues A and B can be used to predict the location of the peaks (A). How well the real fits the predicted peak location is scored by a flat bottom scoring function (B).](figures/malandro_peak_matching.svg){#fig:malandro_peak_matching}


#### 5 Temporarily remove a fraction of the cross peaks

The optimization procedure that follows can be repeated multiple times to create an ensemble of possible sequential assignment, that can be later on compared to one another. If the assignment of a spin system to a residue in the sequence stays the same with different subsets of the data, this might be a good indication that this assignment is correct. In each run a new randomly selected part of the data will be removed before the optimization starts. This is optional as the fraction can be set to 0. Also without removing cross-peaks the result of the optimization will likely be a little different every time depending on how well defined the energy minimum is.


#### 6 Generate a random starting assignment

An random assignment is generated that is consistent with the possible mapping between spin systems and residues determined in step 2. Every residue is assigned to one spin system. This can be an actual spin system or a joker. Not every spin system has to be assigned to a residue though, as there might be a surplus of spin systems.


#### 7 Optimization of the sequential assignment using a simulated annealing / Monte Carlo procedure

For each step in the Monte Carlo procedure two spin systems are selected to exchange residue assignments. In practice this is done by first randomly choosing one spin system, independent on whether it is assigned to a residue or not. Then from th more selective list of spin systems this spin system could ever exchange with, as determined in step 2, randomly one other spin system is chosen. Before the change is attempted, a check is performed to assure that the change would not produce an assignment that is inconsistent with the possible mapping between spin systems and residues. Now the change in energy can be calculated corresponding to the attempt. Therefor the energy of the individual links between the two spin systems and the current neighboring spin systems in the sequence has to be calculated. If both spin systems were assigned to residues this would be 4 links both in the old and the new situation. The energy of one link can be defined as:

$$ E_{link} = \sum_{n=1}^{N_{p}} \frac{E_{peak,n}}{degeneracy_{n}} N_{resonances, total}  $$

where N~p~ is the number of peaks. E~peak, n~ is the peak score of the n-th peak determined in step 4. The degeneracy is the amount of different assignments the peak has at the current point of the minimization. The peak energies are normalized by this value, because if a peak already has a lot of assignments it is not very relevant in proving this link between two spin systems is correct. N~resonances total~ is the total amount of unique resonances playing a role in the assignments of all peaks. The difference in energy is now simply:

$$  \Delta E = E_{links, new} - E_{links, old}  $$

The change will be accepted when the Monte Carlo criterium is fulfilled:

$$  e^\frac{-\Delta E}{kT} \geq random(0 \rightarrow 1)   $$

During the procedure the temperature is lowered in steps, making it harder for assignment changes that increase the energy to be accepted.


![Flow diagram of the (semi-) automatic assignment algorithm.](figures/malandro_flow_diagram.svg){#fig:malandro_flow_diagram}


#### The graphical user interface

A relatively simple GUI was created to chose the data to be used, configure the algorithm and display the results. In the first tab, see figure {@fig:malandro_gui} A, spectra and corresponding peak lists and whether to use the connected labeling scheme are selected. In the second tab, the parameters discussed in step 1 can be set. Also the residue range can be set here, as it can be useful to exclude parts of the sequence from the optimization if it is known that these parts do not give rise to peaks in the spectra. Furthermore the cooling regime and the amount of steps per temperature point can be configured as well as the total amount of runs. When the algorithm is started, the energies at each temperature steps are shown for all annealing runs.

After all annealing runs are completed the results will be shown, see {@fig:malandro_gui} B. The user can walk through the sequence and see a subsequence of five residues at a time. For each residue the spin system selected in a given run is shown. The five tables below summarize the overall outcome of all runs. For each residue all spin systems are shown that could be assigned to this residue consistent with the mapping performed in step 2. For each spin system the percentage of runs this spin system was actually assigned to this residue is shown. When clicking on one of the 'links' buttons in between the buttons representing the residues, all peaks will be shown that were found to connect the two selected spin systems. When clicking on the residue button itself all found intra-residual peaks will be shown for the selected spin system.
Another row of residue buttons can be used to play around with a self defined assignment, independent of the annealing procedure, and check the information supporting that assignment.
The great thing of having the assignment procedure integrated within CCPN Analysis is that it is possible to automatically navigate to a selected peak in the table. This makes checking by eye whether the peak pattern is indeed good prove for the assignment suggested by the algorithm easy and fast. It is also possible to automatically navigate to the expected peak positions of peaks that were not found. This is very important to form an opinion about the correctness of the assignment. In this way it is possible to check whether there is really not a peak, or it was just not picked.
If the user agrees with a certain assignments, they can be transferred to the CCPN project. There are basically two types of assignment. Assignment of spin systems to residues and assignment of resonances to peak dimensions. Both can be done independently. None of the suggested assignment are transferred to the project just by running the algorithm as this will alter the project in a way that might not be wanted. In this way assignments the user agrees on can be cherry-picked and transferred to the project individually. If the user wants to transfer the assignments to the project in bulk anyway, this is possible in the last tab, see figure {@fig:malandro_gui} D. Because every run of the annealing generates a different possible sequential assignment, the user has to chose one. It is also possible to only transfer assignment for those spin systems that were selected in a certain threshold percentage of all runs. This threshold has to be set higher than 50% as it is otherwise unclear which spin system to chose if there could be two spin systems exceeding the threshold otherwise.





![Graphical User Interface of the (semi-)automatic assignment algorithm. A: a subset of spectra can be selected to be used by the routine. B: a number of settings can be configured controlling which information in the CCPN project is used by the algorithm. Also parameters controlling the annealing process are set here. The graph at the bottom shows the progress of the annealing procedure. C: The results are shown in 5 tables, representing 5 consecutive residues in the sequence. In each table all spin systems that can be assigned to that particular residue are listed. When selecting two spin systems for two sequential residues, all peaks that connect these spin systems are listed in the table at the bottom. Assignments can be inspected here and individually transferred to the project. D: Assignments can also be transferred in bulk to the project. In order to do so, the user should indicate which assignments exactly as multiple annealing runs were performed. One of the possibilities is to only assign those spin systems that are assigned in a threshold fraction of all annealing runs.](figures/malandro_gui.png){#fig:malandro_gui}


